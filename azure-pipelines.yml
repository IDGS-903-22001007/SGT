# =====================================================
# 📦 Pipeline para HTML Estático (Usando Flask como Servidor)
# Flujo: CI (Build/Test) -> CD (Deploy)
# Objetivo: Despliegue de login.html con trazabilidad
#
# 🔥 CORRECCIÓN CLAVE: Se añade un paso de CopyFiles@2 para mover
#    requirements.txt a la raíz del artefacto, asegurando que Azure
#    instale las dependencias correctamente.
# =====================================================

trigger:
- main

# ⚠️ Seguimos usando el agente local
pool:
  name: 'AgenteLocal'

# Variables del Proyecto
variables:
  AppSourceDir: '$(Build.SourcesDirectory)'
  ArtifactName: 'sgt-deploy-package'
  DeploymentPath: '$(Build.ArtifactStagingDirectory)/$(ArtifactName)' # Nuevo path temporal
  
  # VALORES DE AZURE CONFIRMADOS
  ServiceConnectionName: 'AZ-Conexion-SGT'        
  AppServiceName: 'sgt-app-integrated-2025'       

stages:

# =====================================================
# 1️⃣ Etapa: CI (Integración Continua) - Build y Test
# =====================================================
- stage: CI_BuildAndTest
  displayName: 'Etapa 1: Integración Continua (Pruebas)'
  jobs:
  - job: PythonCI
    displayName: 'Job: Preparación y Pruebas'
    steps:
    
    # --- 1. Configuración de Python (Necesario para Gunicorn y Pruebas) ---
    - task: UsePythonVersion@0
      displayName: 'Configurar Python 3.11'
      inputs:
        versionSpec: '3.11'

    # --- 2. Instalación de Dependencias y Pruebas (Igual) ---
    - script: |
        pip install -r requirements.txt
      displayName: 'Instalar Flask y Gunicorn'
      
    - script: |
        pytest test --junitxml=results.xml
      displayName: 'Ejecutar Pruebas de Integración Continua'
      continueOnError: false

    - task: PublishTestResults@2
      displayName: 'Publicar Resultados de Pruebas (Actividad 14)'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/results.xml'
        failTaskOnFailedTests: true
        
    # 💥 CORRECCIÓN DE EMPAQUETADO: Crear la estructura del paquete
    # --- 4a. Copiar archivos al Staging Directory ---
    # Copia la carpeta 'sgt' completa (con main.py)
    - task: CopyFiles@2
      displayName: 'Copiar Carpeta SGT al Staging'
      inputs:
        SourceFolder: '$(AppSourceDir)'
        Contents: 'sgt/**'
        TargetFolder: '$(DeploymentPath)/sgt' # Cambiado para que sgt quede DENTRO del paquete

    # Copia requirements.txt a la raíz del paquete de despliegue
    - task: CopyFiles@2
      displayName: 'Copiar requirements.txt a la Raíz del Paquete'
      inputs:
        SourceFolder: '$(AppSourceDir)'
        Contents: 'requirements.txt' # Asume que está en la raíz del repo
        TargetFolder: '$(DeploymentPath)'

    # --- 4b. Publicar Artefactos ---
    - task: PublishBuildArtifacts@1
      displayName: 'Publicar Artefacto de Despliegue'
      inputs:
        # Publicamos la carpeta temporal que creamos
        pathToPublish: '$(DeploymentPath)'  
        artifactName: '$(ArtifactName)'

# =====================================================
# 2️⃣ Etapa: CD (Despliegue Continuo)
# =====================================================
- stage: CD_Deployment
  displayName: 'Etapa 2: Despliegue (Entorno Integrado Funcional)'
  dependsOn: CI_BuildAndTest
  condition: succeeded()
  
  jobs:
  - deployment: DeployFunctionalIncrement
    displayName: 'Job: Despliegue a App Service'
    
    workspace:
      clean: all
    
    environment: 'Entorno-Integrado-SGT'  
    
    strategy:
      runOnce:
        deploy:
          steps:
          
          - task: DownloadPipelineArtifact@2
            displayName: 'Descargar Artefacto de Código'
            inputs:
              artifactName: '$(ArtifactName)'
              path: '$(Pipeline.Workspace)/$(ArtifactName)' 

          - task: AzureWebApp@1
            displayName: 'Desplegar Archivo HTML con Servidor Python'
            inputs:
              azureSubscription: '$(ServiceConnectionName)'  
              appName: '$(AppServiceName)'   
              appType: webApp
              package: '$(Pipeline.Workspace)/$(ArtifactName)'  
              # Usamos 'sgt.main:app' porque main.py está dentro de 'sgt/'
              startupCommand: 'gunicorn --bind=0.0.0.0 --workers=4 --timeout=90 sgt.main:app'
              # 🚀 NUEVO: Configuraciones para App Service que fuerzan la ejecución
              # WEBSITE_RUN_FROM_PACKAGE: 0 deshabilita la ejecución desde el ZIP
              # (aunque Azure WebApp task lo maneja, a veces es útil forzarlo)
              # y PYTHONSTARTUP para apuntar al archivo de inicio (aunque Gunicorn lo hace)
              # El parámetro "WEBSITES_ENABLE_APP_SERVICE_STORAGE" en "true" es importante.
              appSettings: |
                - PYTHONSTARTUP ""
                - WEBSITES_ENABLE_APP_SERVICE_STORAGE true
