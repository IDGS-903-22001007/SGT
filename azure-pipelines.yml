# =====================================================
# üì¶ Pipeline para HTML Est√°tico (Usando Flask como Servidor)
# Flujo: CI (Build/Test) -> CD (Deploy)
# Objetivo: Despliegue de login.html con trazabilidad
#
# üî• CORRECCI√ìN APLICADA: Se a√±adi√≥ 'workspace: clean: all' al job de
#    despliegue para resolver el error 'System.IO.IOException: Cannot create...'
#    en el agente local.
# =====================================================

trigger:
- main

# ‚ö†Ô∏è Seguimos usando el agente local
pool:
  name: 'AgenteLocal'

# Variables del Proyecto
variables:
  AppSourceDir: '$(Build.SourcesDirectory)'
  ArtifactName: 'sgt-deploy-package'
  
  # VALORES DE AZURE CONFIRMADOS
  ServiceConnectionName: 'AZ-Conexion-SGT'        
  AppServiceName: 'sgt-app-integrated-2025'       

stages:

# =====================================================
# 1Ô∏è‚É£ Etapa: CI (Integraci√≥n Continua) - Build y Test
# =====================================================
- stage: CI_BuildAndTest
  displayName: 'Etapa 1: Integraci√≥n Continua (Pruebas)'
  jobs:
  - job: PythonCI
    displayName: 'Job: Preparaci√≥n y Pruebas'
    steps:
    
    # --- 1. Configuraci√≥n de Python (Necesario para Gunicorn y Pruebas) ---
    - task: UsePythonVersion@0
      displayName: 'Configurar Python 3.11'
      inputs:
        versionSpec: '3.11'

    # --- 2. Instalaci√≥n de Dependencias (Flask y Gunicorn) ---
    - script: |
        pip install -r requirements.txt
      displayName: 'Instalar Flask y Gunicorn'
      
    # --- 3. Ejecutar Pruebas (Actividad 14) ---
    - script: |
        pytest test --junitxml=results.xml
      displayName: 'Ejecutar Pruebas de Integraci√≥n Continua'
      continueOnError: false

    - task: PublishTestResults@2
      displayName: 'Publicar Resultados de Pruebas (Actividad 14)'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/results.xml'
        failTaskOnFailedTests: true
        
    # --- 4. Publicar Artefactos ---
    - task: PublishBuildArtifacts@1
      displayName: 'Publicar Artefacto del Build (Carpeta /sgt)'
      inputs:
        pathToPublish: '$(AppSourceDir)/sgt'  
        artifactName: '$(ArtifactName)'

# =====================================================
# 2Ô∏è‚É£ Etapa: CD (Despliegue Continuo)
# =====================================================
- stage: CD_Deployment
  displayName: 'Etapa 2: Despliegue (Entorno Integrado Funcional)'
  dependsOn: CI_BuildAndTest
  condition: succeeded()
  
  jobs:
  - deployment: DeployFunctionalIncrement
    displayName: 'Job: Despliegue a App Service'
    
    # ‚úÖ CORRECCI√ìN CLAVE: Limpiar el espacio de trabajo antes de descargar
    #    artefactos para evitar el error de System.IO.IOException.
    workspace:
      clean: all
    
    environment: 'Entorno-Integrado-SGT'  
    
    strategy:
      runOnce:
        deploy:
          steps:
          
          - task: DownloadPipelineArtifact@2
            displayName: 'Descargar Artefacto de C√≥digo'
            inputs:
              artifactName: '$(ArtifactName)'
              # El directorio se limpiar√°, por lo que esta ruta es segura.
              path: '$(Pipeline.Workspace)/$(ArtifactName)' 

          - task: AzureWebApp@1
            displayName: 'Desplegar Archivo HTML con Servidor Python'
            inputs:
              azureSubscription: '$(ServiceConnectionName)'  
              appName: '$(AppServiceName)'   
              appType: webApp # CORRECCI√ìN PREVIA: Especificar el tipo de App Service.
              package: '$(Pipeline.Workspace)/$(ArtifactName)'  
              startupCommand: 'gunicorn --bind=0.0.0.0 --workers=4 --timeout=90 main:app'
          
          - script: |
              echo "‚úÖ Pipeline CI/CD completado exitosamente."
              echo "Actividad 15: Evidencia de funcionalidad integrada (HTML Desplegado)."
              echo "URL de App Service: https://$(AppServiceName).azurewebsites.net"
            displayName: 'Mensaje de √âxito y URL de Validaci√≥n'