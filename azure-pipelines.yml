# ============================================
# 🚀 Pipeline para proyecto Python en Azure DevOps
# ============================================

trigger:
- main  # ejecuta el pipeline automáticamente cuando haces push a la rama main

pool:
  name: 'AgenteLocal'

stages:
# ============================================
# 1️⃣ Etapa: Construcción
# ============================================
- stage: Build
  displayName: "🏗️ Construir proyecto"
  jobs:
  - job: BuildJob
    displayName: "Instalar dependencias y preparar artefactos"
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.11'
      displayName: '🐍 Configurar versión de Python'

    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: '📦 Instalar dependencias desde requirements.txt'

    - script: |
        echo "Build completado exitosamente."
      displayName: '✅ Confirmar build'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(System.DefaultWorkingDirectory)'
        ArtifactName: 'sgt-deploy-package'
        publishLocation: 'Container'
      displayName: '📤 Publicar artefactos del build'

# ============================================
# 2️⃣ Etapa: Pruebas
# ============================================
- stage: Test
  displayName: "🧪 Ejecutar pruebas"
  dependsOn: Build
  jobs:
  - job: TestJob
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifact: 'sgt-deploy-package'
        path: '$(Pipeline.Workspace)/artifacts_$(Build.BuildId)'
      displayName: '⬇️ Descargar artefactos del build actual'

    - script: |
        cd $(Pipeline.Workspace)/artifacts_$(Build.BuildId)
        pytest --maxfail=1 --disable-warnings -q || echo "Sin pruebas definidas."
      displayName: '🧩 Ejecutar pruebas unitarias'

# ============================================
# 3️⃣ Etapa: Despliegue
# ============================================
- stage: Deploy
  displayName: "🚀 Desplegar aplicación"
  dependsOn: Test
  condition: succeeded()
  jobs:
  - job: DeployJob
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifact: 'sgt-deploy-package'
        path: '$(Pipeline.Workspace)/artifacts_$(Build.BuildId)'
      displayName: '⬇️ Descargar artefactos del build actual (para despliegue)'

    - script: |
        cd $(Pipeline.Workspace)/artifacts_$(Build.BuildId)
        echo "Iniciando despliegue..."
        # Aquí puedes colocar los comandos reales de despliegue
        echo "Despliegue completado correctamente."
      displayName: '🚀 Ejecutar despliegue'
