# =====================================================
# üì¶ Pipeline CI/CD para App Flask (SGT)
# Flujo: CI (Empaquetado) -> CD (Deploy a Azure WebApp)
# Soluci√≥n FINAL para pyodbc en Linux
# =====================================================

trigger:
- main

pool:
  name: 'AgenteLocal'

variables:
  AppSourceDir: '$(Build.SourcesDirectory)/sgt'
  ArtifactName: 'sgt-deploy-package'
  DeploymentPath: '$(Build.ArtifactStagingDirectory)/$(ArtifactName)'
  ServiceConnectionName: 'AZ-Conexion-SGT'
  AppServiceName: 'sgt-app-integrated-2025'
  PythonVersion: '3.11' # ‚úÖ Versi√≥n centralizada


# =====================================================
# 1Ô∏è‚É£ Etapa: CI - Integraci√≥n Continua (Empaquetado)
# =====================================================
stages:
- stage: CI_Build
  displayName: 'Etapa 1: Integraci√≥n Continua (Empaquetado)'
  jobs:
  - job: PythonCI
    displayName: 'Job: Instalaci√≥n y Empaquetado'
    steps:

    # --- 0. Limpiar workspace ---
    - script: |
        echo "üßπ Limpiando directorio de trabajo previo..."
        git clean -xfd
        echo "Verificando contenido actual de requirements.txt:"
        type requirements.txt
      displayName: 'Limpiar workspace y mostrar requirements.txt'

    # --- 1. Configurar versi√≥n de Python ---
    - task: UsePythonVersion@0
      displayName: 'Configurar Python $(PythonVersion)' # ‚úÖ Se usa la variable aqu√≠
      inputs:
        versionSpec: '$(PythonVersion)' # ‚úÖ Se usa la variable aqu√≠

    # --- 2. Instalar dependencias ---
    - script: |
        echo "üì¶ Instalando dependencias..."
        pip install --upgrade pip
        pip install -r requirements.txt || (echo "Reintentando instalaci√≥n..." && pip install -r requirements.txt)
      displayName: 'Instalar Flask y dependencias'

    # ‚úÖ Crea el directorio de artefactos ANTES de copiar archivos
    - script: |
        # Esto soluciona el error "Not found PathtoPublish"
        mkdir -p "$(DeploymentPath)"
        echo "Directorio de despliegue creado: $(DeploymentPath)"
      displayName: 'Crear Directorio de Artefactos'

    # --- 3. Copiar archivos para despliegue ---
    - task: CopyFiles@2
      displayName: 'Copiar C√≥digo de Aplicaci√≥n'
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: |
          sgt/** # Tu c√≥digo fuente, incluyendo main.py
          requirements.txt     # CR√çTICO: Para instalar dependencias en Azure
          templates/** # CR√çTICO: Templates en la ra√≠z
          start.sh # üõ†Ô∏è Nuevo script de inicio
        TargetFolder: '$(DeploymentPath)'

    # üõ†Ô∏è CORRECCI√ìN FINAL: Asignar permisos de ejecuci√≥n al script
    - script: |
        echo "Dando permisos de ejecuci√≥n a start.sh"
        chmod +x "$(DeploymentPath)/start.sh"
      displayName: 'Asignar Permisos a start.sh'


    # --- 4. Publicar artefactos ---
    - task: PublishPipelineArtifact@1 
      displayName: 'Publicar Artefacto de Despliegue'
      inputs:
        targetPath: '$(DeploymentPath)' 
        artifact: '$(ArtifactName)'     


# =====================================================
# 2Ô∏è‚É£ Etapa: CD - Despliegue Continuo en Azure
# =====================================================
- stage: CD_Deployment
  displayName: 'Etapa 2: Despliegue en Azure App Service'
  dependsOn: CI_Build
  condition: succeeded()
  
  jobs:
  - deployment: DeployToAzure
    displayName: 'Job: Desplegar Flask App en Azure'
    environment: 'Entorno-Integrado-SGT'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Descargar Artefacto de C√≥digo Empaquetado'
            inputs:
              artifactName: '$(ArtifactName)'
              downloadPath: '$(Pipeline.Workspace)/$(ArtifactName)'

          - task: AzureWebApp@1
            displayName: 'Desplegar Flask App a Azure App Service'
            inputs:
              azureSubscription: '$(ServiceConnectionName)'
              appName: '$(AppServiceName)'
              appType: webApp
              package: '$(Pipeline.Workspace)/$(ArtifactName)/'
              # üõ†Ô∏è Ejecuta el script de shell que instala el driver ODBC y luego Gunicorn.
              startupCommand: 'bash start.sh'


# =====================================================
# 3Ô∏è‚É£ Etapa: Test Funcional Post-Deploy (Opcional)
# =====================================================
- stage: Functional_Tests
  displayName: "Etapa 3: Verificacion Post Despliegue (opcional)"
  dependsOn: CD_Deployment
  condition: succeeded()
  
  jobs:
  - job: FunctionalTest
    displayName: "Job: Verificacion del Despliegue (externa)"
    pool:
      name: "AgenteLocal"
    steps:
      - script: |
          echo "Despliegue completado correctamente."
          echo "La verificacion funcional sera realizada con una herramienta externa."
        displayName: "Notificacion de exito"
