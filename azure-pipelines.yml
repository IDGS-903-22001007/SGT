# =====================================================
# üöÄ Pipeline CI/CD para Sistema de Gesti√≥n de Transporte (SGT)
# Flujo completo: CI (Build/Test) ‚Üí CD (Deploy) ‚Üí Post-Deploy Test
# =====================================================

trigger:
- main

# üë∑ Agente
pool:
  name: 'AgenteLocal'

# üîß Variables globales
variables:
  AppSourceDir: '$(Build.SourcesDirectory)/sgt'
  ArtifactName: 'sgt-deploy-package'
  DeploymentPath: '$(Build.ArtifactStagingDirectory)/$(ArtifactName)'
  ServiceConnectionName: 'AZ-Conexion-SGT'
  AppServiceName: 'sgt-app-integrated-2025-atg7ambqdkbhf0b6'

# =====================================================
# üß© Etapa 1: Integraci√≥n Continua (Build + Pruebas)
# =====================================================
stages:
- stage: CI_BuildAndTest
  displayName: 'Etapa 1: Integraci√≥n Continua (Pruebas y Empaquetado)'
  jobs:
  - job: PythonCI
    displayName: 'Job: Instalaci√≥n, Pruebas y Empaquetado'
    steps:

    # --- 1Ô∏è‚É£ Configurar Python ---
    - task: UsePythonVersion@0
      displayName: 'Configurar Python 3.11'
      inputs:
        versionSpec: '3.11'

    # --- 2Ô∏è‚É£ Instalar dependencias ---
    - script: |
        echo "üì¶ Instalando dependencias del proyecto..."
        pip install -r requirements.txt
        pip install pytest requests
      displayName: 'Instalar dependencias (Flask, pytest, etc)'

    # --- 3Ô∏è‚É£ Ejecutar pruebas unitarias ---
    - script: |
        echo "üöÄ Ejecutando pruebas unitarias de CI..."
        pytest test -v --maxfail=1 --disable-warnings --junitxml=results.xml | tee pytest.log
      displayName: 'Ejecutar Pruebas Unitarias (FAIL ON ERROR)'

    # --- 4Ô∏è‚É£ Publicar resultados de pruebas ---
    - task: PublishTestResults@2
      displayName: 'Publicar Resultados de Pruebas Unitarias'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '/results.xml'
        failTaskOnFailedTests: true

    # --- 5Ô∏è‚É£ Publicar log completo como artefacto ---
    - task: PublishBuildArtifacts@1
      displayName: 'Publicar Log de Pruebas Unitarias'
      inputs:
        pathToPublish: 'pytest.log'
        artifactName: 'logs_pruebas_unitarias'

    # --- 6Ô∏è‚É£ Copiar archivos para despliegue ---
    - task: CopyFiles@2
      displayName: 'Copiar C√≥digo para Despliegue'
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: |
          sgt/**
          requirements.txt
          test_deployment.py
        TargetFolder: '$(DeploymentPath)'

    # --- 7Ô∏è‚É£ Publicar artefactos para CD ---
    - task: PublishBuildArtifacts@1
      displayName: 'Publicar Artefacto de Despliegue'
      inputs:
        pathToPublish: '$(DeploymentPath)'
        artifactName: '$(ArtifactName)'

# =====================================================
# üåê Etapa 2: Despliegue Continuo en Azure
# =====================================================
- stage: CD_Deployment
  displayName: 'Etapa 2: Despliegue en Azure App Service'
  dependsOn: CI_BuildAndTest
  condition: succeeded()
  jobs:
  - deployment: DeployToAzure
    displayName: 'Job: Desplegar Flask App en Azure'
    environment: 'Entorno-Integrado-SGT'
    strategy:
      runOnce:
        deploy:
          steps:
          # --- Descargar artefactos ---
          - task: DownloadPipelineArtifact@2
            displayName: 'Descargar Artefacto del Build'
            inputs:
              artifactName: '$(ArtifactName)'
              path: '$(Pipeline.Workspace)/$(ArtifactName)'

          # --- Desplegar a Azure ---
          - task: AzureWebApp@1
            displayName: 'Desplegar Aplicaci√≥n Flask en Azure'
            inputs:
              azureSubscription: '$(ServiceConnectionName)'
              appName: '$(AppServiceName)'
              appType: webApp
              package: '$(Pipeline.Workspace)/$(ArtifactName)/'
              startupCommand: 'gunicorn --bind=0.0.0.0 --workers=4 --timeout=90 sgt.main:app'

# =====================================================
# üß™ Etapa 3: Pruebas Funcionales Post-Despliegue
# =====================================================
- stage: Functional_Tests
  displayName: 'Etapa 3: Pruebas Funcionales Post-Despliegue'
  dependsOn: CD_Deployment
  condition: succeeded()
  jobs:
  - job: FunctionalTest
    displayName: 'Job: Validaci√≥n en Entorno Productivo (Staging)'
    pool:
      name: 'AgenteLocal'
    steps:
      - task: UsePythonVersion@0
        displayName: 'Configurar Python 3.11'
        inputs:
          versionSpec: '3.11'
      - script: |
          echo "üß© Instalando librer√≠as de prueba..."
          pip install requests pytest
      - script: |
          echo "üîç Ejecutando pruebas funcionales en la app desplegada..."
          pytest $(Pipeline.Workspace)/$(ArtifactName)/test_deployment.py -v | tee functional_tests.log
      - task: PublishBuildArtifacts@1
        displayName: 'Publicar Log de Pruebas Funcionales'
        inputs:
          pathToPublish: 'functional_tests.log'
          artifactName: 'logs_pruebas_funcionales'