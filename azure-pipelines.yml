# =====================================================
# ğŸ“¦ Pipeline CI/CD para App Flask (SGT)
# Flujo: CI (Build/Test) -> CD (Deploy a Azure WebApp)
# Objetivo: Desplegar login.html servido por Flask
#
# ğŸ§  Estructura esperada:
# SGT/
# â”£ ğŸ“‚ sgt/
# â”ƒ â”£ ğŸ“œ main.py
# â”ƒ â”£ ğŸ“‚ templates/login.html
# â”ƒ â”— ğŸ“‚ static/ (opcional)
# â”£ ğŸ“œ requirements.txt
# â”£ ğŸ“œ test_deployment.py <--- Archivo de prueba funcional aÃ±adido
# =====================================================

trigger:
- main

# ğŸ‘·â€â™‚ï¸ Agente local para ejecutar el pipeline
pool:
  name: 'AgenteLocal'

# Variables globales del proyecto
variables:
  AppSourceDir: '$(Build.SourcesDirectory)/sgt'
  ArtifactName: 'sgt-deploy-package'
  DeploymentPath: '$(Build.ArtifactStagingDirectory)/$(ArtifactName)'
  
  # âš™ï¸ Variables de Azure App Service
  ServiceConnectionName: 'AZ-Conexion-SGT'
  AppServiceName: 'sgt-app-integrated-2025-atg7ambqdkbhf0b6' # Usamos el nombre de la app (sin el .azurewebsites.net)

# =====================================================
# 1ï¸âƒ£ Etapa: CI - IntegraciÃ³n Continua (Pruebas Unitarias)
# =====================================================
stages:
- stage: CI_BuildAndTest
  displayName: 'Etapa 1: IntegraciÃ³n Continua (Pruebas y Empaquetado)'
  jobs:
  - job: PythonCI
    displayName: 'Job: InstalaciÃ³n, Pruebas y Empaquetado'
    steps:

    # --- 1. Configurar versiÃ³n de Python ---
    - task: UsePythonVersion@0
      displayName: 'Configurar Python 3.11'
      inputs:
        versionSpec: '3.11'

      # --- 2. Instalar dependencias (Separado para aislar errores) ---
    - script: |
        pip install -r requirements.txt
      displayName: 'Instalar dependencias del proyecto (Flask, SQLAlchemy, etc.)'

    # --- 2b. Instalar herramientas de CI/CD ---
    - script: |
        pip install pytest requests
      displayName: 'Instalar herramientas de Pruebas (pytest y requests)'


    # --- 3. Ejecutar pruebas unitarias (Actividad 14: Logs) ---
    - script: |
        echo "Ejecutando pruebas unitarias de CI..."
        pytest test --junitxml=results.xml
      displayName: 'Ejecutar Pruebas Unitarias (FAIL ON ERROR)'
      # Se asume que el comando 'pytest' fallarÃ¡ si las pruebas unitarias fallan,
      # lo cual detendrÃ¡ el pipeline.

    - task: PublishTestResults@2
      displayName: 'Publicar Resultados de Pruebas Unitarias'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/results.xml'
        failTaskOnFailedTests: true # DEBE SER TRUE para un CI riguroso

    # --- 4. Copiar archivos para despliegue ---
    - task: CopyFiles@2
      displayName: 'Copiar CÃ³digo de AplicaciÃ³n'
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: |
          sgt/**
          requirements.txt
          test_deployment.py # Incluir el script de prueba funcional
        TargetFolder: '$(DeploymentPath)'

    # --- 5. Publicar artefactos ---
    - task: PublishBuildArtifacts@1
      displayName: 'Publicar Artefacto de Despliegue'
      inputs:
        pathToPublish: '$(DeploymentPath)'
        artifactName: '$(ArtifactName)'

# =====================================================
# 2ï¸âƒ£ Etapa: CD - Despliegue Continuo en Azure
# =====================================================
- stage: CD_Deployment
  displayName: 'Etapa 2: Despliegue en Azure App Service'
  dependsOn: CI_BuildAndTest
  condition: succeeded()
  
  jobs:
  - deployment: DeployToAzure
    displayName: 'Job: Desplegar Flask App en Azure'
    environment: 'Entorno-Integrado-SGT'
    strategy:
      runOnce:
        deploy:
          steps:

          # --- 1. Descargar artefactos ---
          - task: DownloadPipelineArtifact@2
            displayName: 'Descargar Artefacto de CÃ³digo Empaquetado'
            inputs:
              artifactName: '$(ArtifactName)'
              path: '$(Pipeline.Workspace)/$(ArtifactName)'

          # --- 2. Desplegar a Azure ---
          - task: AzureWebApp@1
            displayName: 'Desplegar Flask App a Azure App Service'
            inputs:
              azureSubscription: '$(ServiceConnectionName)'
              appName: '$(AppServiceName)'
              appType: webApp
              package: '$(Pipeline.Workspace)/$(ArtifactName)/' # AsegÃºrate de que apunte a la carpeta
              startupCommand: 'gunicorn --bind=0.0.0.0 --workers=4 --timeout=90 sgt.main:app'

# =====================================================
# 3ï¸âƒ£ Etapa: Test Funcional Post-Deploy (Staging/Metricas)
# =====================================================
- stage: Functional_Tests
  displayName: 'Etapa 3: Pruebas Funcionales Post-Despliegue (Staging)'
  dependsOn: CD_Deployment
  condition: succeeded()
  
  jobs:
  - job: FunctionalTest
    displayName: 'Job: Ejecutar Pruebas contra la URL'
    pool:
      name: 'AgenteLocal' # Usar un agente para ejecutar la prueba
    steps:
      - task: UsePythonVersion@0
        displayName: 'Configurar Python 3.11'
        inputs:
          versionSpec: '3.11'
          
      - script: |
          pip install requests pytest
        displayName: 'Instalar dependencias de prueba'
        
      # --- 1. Ejecutar el script de prueba funcional (Actividad 14: MÃ©tricas) ---
      - script: |
          echo "Ejecutando pruebas funcionales en la URL desplegada..."
          # Usamos 'pytest' para ejecutar el script que probarÃ¡ la URL
          pytest $(Pipeline.Workspace)/$(ArtifactName)/test_deployment.py
        displayName: 'Ejecutar Pruebas de Despliegue contra URL'
