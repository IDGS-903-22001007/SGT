# =====================================================
# üì¶ Pipeline para HTML Est√°tico (FINAL)
# =====================================================

trigger:
- main

pool:
  name: 'AgenteLocal'

variables:
  AppSourceDir: '$(Build.SourcesDirectory)'
  ArtifactName: 'sgt-deploy-package'
  ServiceConnectionName: 'AZ-Conexion-SGT'        
  AppServiceName: 'sgt-app-integrated-2025'       
  PythonVersion: '3.11' # Agregada la versi√≥n de Python

stages:

# =====================================================
# 1Ô∏è‚É£ Etapa: CI (Integraci√≥n Continua) - Build y Test
# =====================================================
- stage: CI_BuildAndTest
  displayName: 'Etapa 1: Integraci√≥n Continua (Pruebas)'
  jobs:
  - job: PythonCI
    displayName: 'Job: Preparaci√≥n y Pruebas'
    steps:
    
    - task: UsePythonVersion@0
      displayName: 'Configurar Python $(PythonVersion)'
      inputs:
        versionSpec: '$(PythonVersion)'

    - script: |
        pip install -r requirements.txt
      displayName: 'Instalar Flask y Gunicorn'
      
    - script: |
        pytest test --junitxml=results.xml
      displayName: 'Ejecutar Pruebas de Integraci√≥n Continua'
      continueOnError: false

    - task: PublishTestResults@2
      displayName: 'Publicar Resultados de Pruebas (Actividad 14)'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/results.xml'
        failTaskOnFailedTests: true
        
    # --- 4. Publicar Artefactos ---
    - task: PublishBuildArtifacts@1
      displayName: 'Publicar Artefacto del Build (Carpeta Ra√≠z)'
      inputs:
        # üî• CAMBIO CLAVE: Publicamos desde la ra√≠z, no desde /sgt
        pathToPublish: '$(AppSourceDir)/sgt'  

        artifactName: '$(ArtifactName)'

# =====================================================
# 2Ô∏è‚É£ Etapa: CD (Despliegue Continuo)
# =====================================================
- stage: CD_Deployment
  displayName: 'Etapa 2: Despliegue (Entorno Integrado Funcional)'
  dependsOn: CI_BuildAndTest
  condition: succeeded()
  
  jobs:
  - deployment: DeployFunctionalIncrement
    displayName: 'Job: Despliegue a App Service'
    
    environment: 'Entorno-Integrado-SGT'  
    
    strategy:
      runOnce:
        deploy:
          steps:
          
          - task: DownloadPipelineArtifact@2
            displayName: 'Descargar Artefacto de C√≥digo'
            inputs:
              artifactName: '$(ArtifactName)'
              path: '$(Pipeline.Workspace)/$(ArtifactName)'

          - task: AzureWebApp@1
            displayName: 'Desplegar Archivo HTML con Servidor Python'
            inputs:
              azureSubscription: '$(ServiceConnectionName)'  
              appName: '$(AppServiceName)'   
              appType: webApp
              package: '$(Pipeline.Workspace)/$(ArtifactName)'  
              # üî• startupCommand se queda vac√≠o para que Azure use el est√°ndar: gunicorn --bind=0.0.0.0 --workers=1 main:app
          
          - script: |
              echo "‚úÖ Pipeline CI/CD completado exitosamente."
              echo "Actividad 15: Evidencia de funcionalidad integrada (HTML Desplegado)."
              echo "URL de App Service: https://$(AppServiceName).azurewebsites.net"
            displayName: 'Mensaje de √âxito y URL de Validaci√≥n'
