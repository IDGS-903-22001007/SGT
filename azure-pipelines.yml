# ============================================
# ğŸš€ Pipeline para proyecto Python en Azure DevOps
# ============================================

trigger:
- main  # ejecuta el pipeline automÃ¡ticamente cuando haces push a la rama main

pool:
  name: 'AgenteLocal'

stages:
# ============================================
# 1ï¸âƒ£ Etapa: ConstrucciÃ³n
# ============================================
- stage: Build
  displayName: "ğŸ—ï¸ Construir proyecto"
  jobs:
  - job: BuildJob
    displayName: "Instalar dependencias y preparar artefactos"
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.11'
      displayName: 'ğŸ Configurar versiÃ³n de Python'

    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'ğŸ“¦ Instalar dependencias desde requirements.txt'

    - script: |
        echo "Build completado exitosamente."
      displayName: 'âœ… Confirmar build'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(System.DefaultWorkingDirectory)'
        ArtifactName: 'sgt-deploy-package'
        publishLocation: 'Container'
      displayName: 'ğŸ“¤ Publicar artefactos del build'

# ============================================
# 2ï¸âƒ£ Etapa: Pruebas
# ============================================
- stage: Test
  displayName: "ğŸ§ª Ejecutar pruebas"
  dependsOn: Build
  jobs:
  - job: TestJob
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifact: 'sgt-deploy-package'
        path: '$(Pipeline.Workspace)/artifacts_$(Build.BuildId)'
      displayName: 'â¬‡ï¸ Descargar artefactos del build actual'

    - script: |
        cd $(Pipeline.Workspace)/artifacts_$(Build.BuildId)
        pytest --maxfail=1 --disable-warnings -q || echo "Sin pruebas definidas."
      displayName: 'ğŸ§© Ejecutar pruebas unitarias'

# ============================================
# 3ï¸âƒ£ Etapa: Despliegue
# ============================================
- stage: Deploy
  displayName: "ğŸš€ Desplegar aplicaciÃ³n"
  dependsOn: Test
  condition: succeeded()
  jobs:
  - job: DeployJob
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifact: 'sgt-deploy-package'
        path: '$(Pipeline.Workspace)/artifacts_$(Build.BuildId)'
      displayName: 'â¬‡ï¸ Descargar artefactos del build actual (para despliegue)'

    - script: |
        cd $(Pipeline.Workspace)/artifacts_$(Build.BuildId)
        echo "Iniciando despliegue..."
        # AquÃ­ puedes colocar los comandos reales de despliegue
        echo "Despliegue completado correctamente."
      displayName: 'ğŸš€ Ejecutar despliegue'
